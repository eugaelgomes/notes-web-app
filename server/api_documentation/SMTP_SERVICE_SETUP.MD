# üìß SMTP Service Setup - Codaweb Notes

> Guia completo para configura√ß√£o do servi√ßo de envio de emails usando Nodemailer com diferentes provedores SMTP.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Provedores Suportados](#provedores-suportados)
- [Configura√ß√£o Atual (Zoho)](#configura√ß√£o-atual-zoho)
- [Configura√ß√£o de Outros Provedores](#configura√ß√£o-de-outros-provedores)
- [Vari√°veis de Ambiente](#vari√°veis-de-ambiente)
- [Templates de Email](#templates-de-email)
- [Implementa√ß√£o](#implementa√ß√£o)
- [Testes](#testes)
- [Troubleshooting](#troubleshooting)
- [Seguran√ßa](#seguran√ßa)

## üîç Vis√£o Geral

O sistema de email do Codaweb Notes utiliza **Nodemailer** para envio de emails transacionais, incluindo:

- ‚úÖ **Email de Boas-vindas** ap√≥s registro
- ‚úÖ **Recupera√ß√£o de Senha** com token seguro
- ‚úÖ **Templates HTML responsivos**
- ‚úÖ **Suporte a m√∫ltiplos provedores SMTP**

### Arquitetura do Sistema

```
src/services/email/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ mail-service.js          # Configura√ß√£o do transporter
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ welcome-mail.js          # Template de boas-vindas
‚îÇ   ‚îî‚îÄ‚îÄ rescue-pass-mail.js      # Template de recupera√ß√£o
```

## üåê Provedores Suportados

### Atualmente Configurado: Zoho Mail

O projeto est√° configurado para usar **Zoho Mail** como provedor SMTP principal:

```javascript
// Configura√ß√£o atual em mail-service.js
{
  host: "smtp.zoho.com",
  port: 465,
  secure: true,
  auth: {
    user: process.env.EMAIL_USERNAME,
    pass: process.env.EMAIL_PASSWORD,
  }
}
```

### Outros Provedores Compat√≠veis

| Provedor | Host | Porta | Secure |
|----------|------|-------|---------|
| **Gmail** | smtp.gmail.com | 587 | false |
| **Outlook** | smtp-mail.outlook.com | 587 | false |
| **Yahoo** | smtp.mail.yahoo.com | 587 | false |
| **SendGrid** | smtp.sendgrid.net | 587 | false |
| **Mailgun** | smtp.mailgun.org | 587 | false |
| **Amazon SES** | email-smtp.region.amazonaws.com | 587 | false |

## ‚öôÔ∏è Configura√ß√£o Atual (Zoho)

### 1. Criar Conta no Zoho Mail

1. Acesse [Zoho Mail](https://www.zoho.com/mail/)
2. Crie uma conta ou use uma existente
3. Configure um dom√≠nio personalizado (opcional)

### 2. Configurar Autentica√ß√£o

#### Op√ß√£o A: Senha de Aplicativo (Recomendado)
```bash
1. Acesse: Zoho Mail > Configura√ß√µes > Seguran√ßa
2. Ative "Autentica√ß√£o de dois fatores"
3. Gere uma "Senha de aplicativo" espec√≠fica
4. Use essa senha nas vari√°veis de ambiente
```

#### Op√ß√£o B: Senha da Conta
```bash
# Menos seguro, use apenas para desenvolvimento
# Use a senha normal da conta Zoho
```

### 3. Configurar Vari√°veis de Ambiente

```env
# SMTP Configuration - Zoho Mail
EMAIL_USERNAME=seu-email@seudominio.com
EMAIL_PASSWORD=sua_senha_de_aplicativo

# Frontend URL para links nos emails
FRONTEND_URL=https://seudominio.com
# ou para desenvolvimento:
FRONTEND_URL=http://localhost:3000

# Email sender information
EMAIL_FROM_NAME=CodaWeb Support
EMAIL_FROM_ADDRESS=support@codaweb.com.br
```

## üîß Configura√ß√£o de Outros Provedores

### Gmail

```javascript
// Substitua em mail-service.js
{
  service: 'gmail', // ou use host: "smtp.gmail.com"
  port: 587,
  secure: false,
  auth: {
    user: process.env.EMAIL_USERNAME,
    pass: process.env.EMAIL_PASSWORD, // Senha de app do Gmail
  }
}
```

**Configura√ß√£o do Gmail:**
1. Ative a verifica√ß√£o em 2 etapas
2. Gere uma senha de app: [Google Account Settings](https://myaccount.google.com/apppasswords)
3. Use a senha de app no `.env`

### Outlook/Hotmail

```javascript
{
  host: "smtp-mail.outlook.com",
  port: 587,
  secure: false,
  auth: {
    user: process.env.EMAIL_USERNAME,
    pass: process.env.EMAIL_PASSWORD,
  }
}
```

### SendGrid

```javascript
{
  host: "smtp.sendgrid.net",
  port: 587,
  secure: false,
  auth: {
    user: "apikey",
    pass: process.env.SENDGRID_API_KEY,
  }
}
```

### Amazon SES

```javascript
{
  host: "email-smtp.us-east-1.amazonaws.com", // Substitua pela sua regi√£o
  port: 587,
  secure: false,
  auth: {
    user: process.env.AWS_SES_ACCESS_KEY,
    pass: process.env.AWS_SES_SECRET_KEY,
  }
}
```

## üìù Vari√°veis de Ambiente

### Arquivo `.env` Completo

```env
# ================================
# SMTP SERVICE CONFIGURATION
# ================================

# Provider: Zoho Mail (atual)
EMAIL_USERNAME=seu-email@zoho.com
EMAIL_PASSWORD=sua_senha_de_aplicativo

# Alternative providers (descomente para usar)
# SENDGRID_API_KEY=SG.xxxxxxxxxxxxx
# AWS_SES_ACCESS_KEY=AKIAXXXXXXXX
# AWS_SES_SECRET_KEY=xxxxxxxxxxxxxxxx

# Email sender configuration
EMAIL_FROM_NAME=CodaWeb Support
EMAIL_FROM_ADDRESS=support@codaweb.com.br

# Frontend URLs for email links
FRONTEND_URL=https://codaweb.com.br
# Development: FRONTEND_URL=http://localhost:3000

# Email settings
EMAIL_TIMEOUT=30000
EMAIL_CONNECTION_TIMEOUT=60000

# Environment
NODE_ENV=production
```

### Valida√ß√£o de Vari√°veis

Adicione ao in√≠cio do `mail-service.js`:

```javascript
// Valida√ß√£o de vari√°veis obrigat√≥rias
const requiredEnvVars = ['EMAIL_USERNAME', 'EMAIL_PASSWORD', 'FRONTEND_URL'];
const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
  throw new Error(`Missing required environment variables: ${missingVars.join(', ')}`);
}
```

## üìÑ Templates de Email

### 1. Welcome Email (`welcome-mail.js`)

**Caracter√≠sticas:**
- ‚úÖ Template HTML responsivo
- ‚úÖ Design moderno com cores da marca
- ‚úÖ Links para redes sociais
- ‚úÖ Compat√≠vel com todos os clientes de email

**Par√¢metros:**
```javascript
welcome_message(nome, email, username)
```

**Personaliza√ß√£o:**
```javascript
// Edite as vari√°veis no template
const brandColor = "#00be67";
const companyName = "CodaWeb";
const supportEmail = "support@codaweb.com.br";
const websiteUrl = "https://codaweb.com.br";
```

### 2. Password Reset (`rescue-pass-mail.js`)

**Caracter√≠sticas:**
- ‚úÖ Token seguro destacado
- ‚úÖ Link direto para reset
- ‚úÖ Expira√ß√£o clara (24 horas)
- ‚úÖ Fallback com token manual

**Par√¢metros:**
```javascript
mail_rescue_pass(email, token)
```

**URLs de Reset:**
```javascript
// Produ√ß√£o
${process.env.FRONTEND_URL}/auth/reset-password?token=${token}

// Desenvolvimento
${process.env.FRONTEND_URL}/?reset_token=${token}
```

### Criando Novos Templates

```javascript
// src/services/email/templates/novo-template.js
const { MailService } = require("@/services/email/config/mail-service");

async function novo_template(parametros) {
  try {
    let mailOptions = {
      from: `${process.env.EMAIL_FROM_NAME} <${process.env.EMAIL_FROM_ADDRESS}>`,
      to: email,
      subject: "Assunto do Email",
      html: `<!-- Seu HTML aqui -->`,
      text: "Vers√£o texto simples" // Fallback
    };
    
    await MailService().sendMail(mailOptions);
    return { success: true };
  } catch (error) {
    console.error("Email failed:", error);
    return { success: false, error: error.message };
  }
}

module.exports = { novo_template };
```

## üöÄ Implementa√ß√£o

### 1. Instala√ß√£o das Depend√™ncias

```bash
# J√° inclu√≠do no package.json
npm install nodemailer
```

### 2. Configura√ß√£o B√°sica

```javascript
// src/services/email/config/mail-service.js
const nodemailer = require("nodemailer");

function MailService() {
  try {
    const config = {
      host: process.env.SMTP_HOST || "smtp.zoho.com",
      port: parseInt(process.env.SMTP_PORT) || 465,
      secure: process.env.SMTP_SECURE === 'true' || true,
      auth: {
        user: process.env.EMAIL_USERNAME,
        pass: process.env.EMAIL_PASSWORD,
      },
      // Configura√ß√µes adicionais
      connectionTimeout: 60000,
      greetingTimeout: 30000,
      socketTimeout: 60000,
    };

    return nodemailer.createTransporter(config);
  } catch (error) {
    console.error("SMTP Configuration Error:", error);
    throw error;
  }
}

module.exports = { MailService };
```

### 3. Uso nos Controllers

```javascript
// Em controllers/auth-controller.js ou user-controller.js
const { welcome_message } = require("@/services/email/templates/welcome-mail");
const mail_rescue_pass = require("@/services/email/templates/rescue-pass-mail");

// Enviar email de boas-vindas
const emailResult = await welcome_message(user.name, user.email, user.email);
if (!emailResult.success) {
  console.error("Failed to send welcome email:", emailResult.error);
}

// Enviar email de recupera√ß√£o
const resetResult = await mail_rescue_pass(email, resetToken);
if (!resetResult.success) {
  console.error("Failed to send reset email:", resetResult.error);
}
```

## üß™ Testes

### 1. Teste Manual

Crie um script de teste:

```javascript
// test-email.js
require('dotenv').config();
const { welcome_message } = require('./src/services/email/templates/welcome-mail');

async function testEmail() {
  try {
    console.log('Testando envio de email...');
    
    const result = await welcome_message(
      "Teste User",
      "seu-email-de-teste@gmail.com",
      "teste@example.com"
    );
    
    if (result.success) {
      console.log('‚úÖ Email enviado com sucesso!');
    } else {
      console.log('‚ùå Falha no envio:', result.error);
    }
  } catch (error) {
    console.error('‚ùå Erro no teste:', error);
  }
}

testEmail();
```

Execute o teste:
```bash
node test-email.js
```

### 2. Teste da Configura√ß√£o SMTP

```javascript
// test-smtp-connection.js
const { MailService } = require('./src/services/email/config/mail-service');

async function testConnection() {
  try {
    const transporter = MailService();
    const isValid = await transporter.verify();
    
    if (isValid) {
      console.log('‚úÖ Conex√£o SMTP v√°lida!');
    } else {
      console.log('‚ùå Conex√£o SMTP inv√°lida');
    }
  } catch (error) {
    console.error('‚ùå Erro na conex√£o:', error);
  }
}

testConnection();
```

### 3. Teste de Integra√ß√£o

```javascript
// tests/email.test.js (para Jest)
const { welcome_message } = require('../src/services/email/templates/welcome-mail');

describe('Email Service', () => {
  test('should send welcome email successfully', async () => {
    const result = await welcome_message(
      "Test User",
      "test@example.com",
      "testuser"
    );
    
    expect(result.success).toBe(true);
  });
});
```

## üîß Troubleshooting

### Problemas Comuns

#### 1. Erro de Autentica√ß√£o
```
Error: Invalid login: 535 5.7.8 Error: authentication failed
```

**Solu√ß√µes:**
- ‚úÖ Verificar se EMAIL_USERNAME e EMAIL_PASSWORD est√£o corretos
- ‚úÖ Usar senha de aplicativo em vez da senha normal
- ‚úÖ Ativar "Acesso de apps menos seguros" (se dispon√≠vel)
- ‚úÖ Verificar se a conta n√£o est√° bloqueada

#### 2. Erro de Conex√£o
```
Error: connect ECONNREFUSED
```

**Solu√ß√µes:**
- ‚úÖ Verificar host e porta SMTP
- ‚úÖ Testar conectividade de rede
- ‚úÖ Verificar firewall e proxy
- ‚úÖ Confirmar se o provedor permite SMTP

#### 3. Timeout
```
Error: Greeting never received
```

**Solu√ß√µes:**
- ‚úÖ Aumentar timeout na configura√ß√£o
- ‚úÖ Verificar lat√™ncia da rede
- ‚úÖ Tentar porta alternativa (25, 465, 587)

#### 4. Rate Limiting
```
Error: 550 5.4.5 Daily sending quota exceeded
```

**Solu√ß√µes:**
- ‚úÖ Verificar limites di√°rios do provedor
- ‚úÖ Implementar queue de emails
- ‚úÖ Distribuir envios ao longo do tempo

### Debug Avan√ßado

Ative logs detalhados:

```javascript
// Em mail-service.js
const transporter = nodemailer.createTransporter({
  // ... configura√ß√µes existentes
  debug: true, // Logs detalhados
  logger: true // Logger ativo
});

// Log de eventos
transporter.on('idle', () => console.log('Transporter idle'));
transporter.on('error', (err) => console.error('Transporter error:', err));
```

### Verifica√ß√£o de DNS

```bash
# Verificar MX records do dom√≠nio
nslookup -type=MX zoho.com

# Teste de conectividade SMTP
telnet smtp.zoho.com 465
```

## üîí Seguran√ßa

### Boas Pr√°ticas

#### 1. Credenciais Seguras
- ‚úÖ **Nunca** commite credenciais no c√≥digo
- ‚úÖ Use senhas de aplicativo espec√≠ficas
- ‚úÖ Rotacione senhas periodicamente
- ‚úÖ Use vari√°veis de ambiente criptografadas

#### 2. Valida√ß√£o de Email
```javascript
// Validar email antes de enviar
const validator = require('validator');

if (!validator.isEmail(email)) {
  throw new Error('Invalid email address');
}
```

#### 3. Rate Limiting
```javascript
// Implementar rate limiting para emails
const rateLimit = require('express-rate-limit');

const emailLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 5, // M√°ximo 5 emails por IP
  message: 'Too many email requests, try again later'
});
```

#### 4. Sanitiza√ß√£o de Dados
```javascript
// Sanitizar dados antes de usar em templates
const escape = require('lodash.escape');

const safeName = escape(userName);
const safeEmail = validator.normalizeEmail(email);
```

### Configura√ß√µes de Seguran√ßa

```javascript
// mail-service.js - Configura√ß√µes seguras
{
  host: process.env.SMTP_HOST,
  port: process.env.SMTP_PORT,
  secure: true, // TLS
  auth: {
    user: process.env.EMAIL_USERNAME,
    pass: process.env.EMAIL_PASSWORD,
  },
  tls: {
    rejectUnauthorized: true,
    minVersion: 'TLSv1.2'
  }
}
```

## üìä Monitoramento

### Logs de Email

```javascript
// Implementar logging estruturado
const winston = require('winston');

const emailLogger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'logs/email.log' })
  ]
});

// Nos templates
emailLogger.info('Email sent', {
  to: email,
  template: 'welcome',
  success: true,
  timestamp: new Date().toISOString()
});
```

### M√©tricas

```javascript
// Contador de emails enviados
let emailStats = {
  sent: 0,
  failed: 0,
  lastSent: null
};

// Incrementar ap√≥s envio
emailStats.sent++;
emailStats.lastSent = new Date();
```

## üìö Recursos Adicionais

### Documenta√ß√£o
- [Nodemailer Documentation](https://nodemailer.com/)
- [Zoho Mail SMTP Settings](https://www.zoho.com/mail/help/smtp-settings.html)
- [Gmail SMTP Settings](https://support.google.com/mail/answer/7126229)

### Ferramentas de Teste
- [Mail Trap](https://mailtrap.io/) - SMTP testing
- [SendGrid Testing](https://sendgrid.com/) - Email delivery testing
- [Mail Hog](https://github.com/mailhog/MailHog) - Local SMTP testing

### Templates Avan√ßados
- [MJML](https://mjml.io/) - Framework para emails responsivos
- [Foundation for Emails](https://get.foundation/emails.html)
- [Email Template Editor](https://unlayer.com/)

---

## üìû Suporte

### Checklist de Configura√ß√£o

- [ ] Vari√°veis de ambiente configuradas
- [ ] Credenciais SMTP v√°lidas
- [ ] Teste de conex√£o realizado
- [ ] Templates funcionando
- [ ] Links de reset configurados
- [ ] Logs implementados

### Contato

Para problemas espec√≠ficos do servi√ßo de email:

1. Verifique os logs da aplica√ß√£o
2. Teste a conex√£o SMTP
3. Valide as credenciais
4. Consulte a documenta√ß√£o do provedor

---

**√öltima atualiza√ß√£o:** Setembro 2025  
**Vers√£o:** 1.0.0  
**Provedor Atual:** Zoho Mail